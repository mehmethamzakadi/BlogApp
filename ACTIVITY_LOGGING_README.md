# BlogApp - Activity Logging & Advanced Logging

## üìä Genel Bakƒ±≈ü

Bu dok√ºman BlogApp'te implementa edilen geli≈ümi≈ü loglama sisteminin detaylarƒ±nƒ± i√ßerir.

### Loglama Katmanlarƒ±

1. **File Logs** - Development ve debugging i√ßin dosya tabanlƒ± loglar
2. **Structured Logs** - Production monitoring i√ßin PostgreSQL tabanlƒ± structured loglar  
3. **Activity Logs** - Compliance ve audit trail i√ßin kullanƒ±cƒ± aktivite loglarƒ±

## üéØ Activity Log Sistemi

### √ñzellikler
- ‚úÖ **Otomatik Loglama:** MediatR pipeline behavior ile t√ºm Create/Update/Delete komutlarƒ± otomatik loglanƒ±r
- ‚úÖ **Kullanƒ±cƒ± ƒ∞zleme:** Hangi kullanƒ±cƒ±nƒ±n ne zaman ne yaptƒ±ƒüƒ±nƒ± kaydeder
- ‚úÖ **Dashboard Entegrasyonu:** API endpoint'leri √ºzerinden aktiviteler sorgulanabilir
- ‚úÖ **Geni≈ületilebilir Yapƒ±:** Yeni entity tipleri kolayca eklenebilir
- ‚úÖ **S√ºresiz Saklama:** Compliance gereksinimleri i√ßin s√ºresiz saklanƒ±r

### Veritabanƒ± Yapƒ±sƒ±

**ActivityLogs Tablosu:**
```sql
CREATE TABLE "ActivityLogs" (
    "Id" SERIAL PRIMARY KEY,
    "ActivityType" VARCHAR(50) NOT NULL,
    "EntityType" VARCHAR(50) NOT NULL,
    "EntityId" INTEGER,
    "Title" VARCHAR(500) NOT NULL,
    "Details" VARCHAR(2000),
    "UserId" INTEGER,
    "Timestamp" TIMESTAMP NOT NULL DEFAULT NOW(),
    CONSTRAINT "FK_ActivityLogs_AppUsers" FOREIGN KEY ("UserId") 
        REFERENCES "AppUsers"("Id") ON DELETE SET NULL
);

CREATE INDEX "IX_ActivityLogs_Timestamp" ON "ActivityLogs"("Timestamp");
CREATE INDEX "IX_ActivityLogs_UserId" ON "ActivityLogs"("UserId");
CREATE INDEX "IX_ActivityLogs_EntityType" ON "ActivityLogs"("EntityType");
```

### Loglanan Aktivite Tipleri

| ActivityType | EntityType | A√ßƒ±klama |
|-------------|------------|----------|
| `post_created` | Post | Yeni blog yazƒ±sƒ± olu≈üturuldu |
| `post_updated` | Post | Blog yazƒ±sƒ± g√ºncellendi |
| `post_deleted` | Post | Blog yazƒ±sƒ± silindi |
| `category_created` | Category | Yeni kategori olu≈üturuldu |
| `category_updated` | Category | Kategori g√ºncellendi |
| `category_deleted` | Category | Kategori silindi |
| `comment_created` | Comment | Yeni yorum yapƒ±ldƒ± |
| `comment_updated` | Comment | Yorum d√ºzenlendi |
| `comment_deleted` | Comment | Yorum silindi |

## üîß Serilog Yapƒ±landƒ±rmasƒ±

### Log Sinks (Hedefler)

1. **Console Sink** - Development i√ßin renkli konsol √ßƒ±ktƒ±sƒ±
2. **File Sink** - G√ºnl√ºk rolling dosyalar (31 g√ºn saklama, 10MB limit)
3. **PostgreSQL Sink** - Structured logging (Information ve √ºzeri, 90 g√ºn saklama)
4. **Seq Sink** - Profesyonel log analiz ve g√∂rselle≈ütirme platformu

### Log Enrichers (Zenginle≈ütirme)

- **MachineName** - Sunucu adƒ±
- **Environment** - Development/Production
- **ProcessId** - ƒ∞≈ülem kimliƒüi
- **ThreadId** - Thread kimliƒüi
- **Application** - Uygulama adƒ± (BlogApp)
- **FromLogContext** - Request bazlƒ± context bilgileri

## ÔøΩ Kullanƒ±m √ñrnekleri

### Otomatik Loglama (MediatR Pipeline)

Activity logging, `ActivityLoggingBehavior` MediatR pipeline behavior'u sayesinde otomatik √ßalƒ±≈üƒ±r:

```csharp
// Post olu≈ütururken
var command = new CreatePostCommand 
{ 
    Title = "Yeni Blog Yazƒ±sƒ±",
    Content = "ƒ∞√ßerik...",
    CategoryId = 1
};
await _mediator.Send(command);

// ActivityLoggingBehavior otomatik olarak ≈üunu loglar:
// ActivityType: "post_created"
// EntityType: "Post"
// Title: "Yeni Blog Yazƒ±sƒ± olu≈üturuldu"
// UserId: Giri≈ü yapmƒ±≈ü kullanƒ±cƒ± ID
// Timestamp: UTC zaman
```

### Manuel Activity Loglama

Gerektiƒüinde repository'yi direkt kullanarak manuel log eklenebilir:

```csharp
public class CustomService
{
    private readonly IActivityLogRepository _activityLogRepository;
    private readonly IHttpContextAccessor _httpContextAccessor;

    public async Task CustomActionAsync()
    {
        var userId = _httpContextAccessor.HttpContext?.User
            .FindFirst(ClaimTypes.NameIdentifier)?.Value;

        var activityLog = new ActivityLog
        {
            ActivityType = "custom_action",
            EntityType = "CustomEntity",
            Title = "√ñzel i≈ülem ger√ßekle≈ütirildi",
            Details = "Ek detaylar...",
            UserId = userId != null ? int.Parse(userId) : null
        };

        await _activityLogRepository.AddAsync(activityLog);
    }
}
```

### Activity Log Sorgulama

API endpoint'i √ºzerinden son aktiviteleri sorgulama:

```http
GET /api/dashboard/activities?pageSize=10
Authorization: Bearer {token}
```

Response:
```json
{
  "success": true,
  "data": [
    {
      "id": 42,
      "activityType": "post_created",
      "entityType": "Post",
      "title": "Yeni Blog Yazƒ±sƒ± olu≈üturuldu",
      "timestamp": "2025-10-25T14:30:00Z",
      "userName": "admin@blog.com"
    }
  ]
}
```

## üìä Structured Logging Best Practices

### Doƒüru Log Seviyeleri

```csharp
// Debug - Geli≈ütirme detaylarƒ± (sadece file'a yazƒ±lƒ±r)
_logger.LogDebug("Processing request for user {UserId}", userId);

// Information - √ñnemli olaylar (file + DB)
_logger.LogInformation("Post {PostId} created successfully by user {UserId}", 
    postId, userId);

// Warning - Potansiyel sorunlar (file + DB + uyarƒ±)
_logger.LogWarning("Rate limit approaching for IP {IpAddress}: {RequestCount} requests", 
    ipAddress, requestCount);

// Error - Hatalar (file + DB + alert)
_logger.LogError(ex, "Failed to process payment for order {OrderId}", orderId);

// Critical - Kritik sistem hatalarƒ± (file + DB + alert + on-call)
_logger.LogCritical(ex, "Database connection lost. ConnectionString: {ConnectionString}", 
    maskedConnectionString);
```

### Structured Logging √ñrnekleri

‚úÖ **ƒ∞Yƒ∞:**
```csharp
// Structured properties
_logger.LogInformation(
    "User {UserId} created post {PostId} in category {CategoryId}",
    userId, postId, categoryId
);

// Complex objects
_logger.LogInformation(
    "Order processed: {@Order}",
    new { OrderId = orderId, Amount = amount, Status = status }
);

// Performance-sensitive logging
if (_logger.IsEnabled(LogLevel.Debug))
{
    var result = await ExpensiveQueryAsync();
    _logger.LogDebug("Query result: {@Result}", result);
}
```

‚ùå **K√ñT√ú:**
```csharp
// String concatenation
_logger.LogInformation("User " + userId + " created post " + postId);

// Sensitive data logging
_logger.LogInformation("User password: {Password}", password);
_logger.LogInformation("Credit card: {CreditCard}", creditCardNumber);

// Exception swallowing
try {
    await DeletePost(postId);
} catch { 
    // ‚ùå Hata loglanmƒ±yor!
}

// Wrong log level
_logger.LogCritical("User clicked button"); // ‚ùå Kritik deƒüil!
```

## üîç Seq Kullanƒ±m √ñrnekleri

### Seq Web Interface
- **URL:** `http://localhost:5341` (Development)
- **URL:** `http://seq:80` (Production - Docker network i√ßinde)

### Temel Sorgular

**1. Son Hatalar:**
```
@Level = 'Error' or @Level = 'Fatal'
```

**2. Belirli Kullanƒ±cƒ±nƒ±n Loglarƒ±:**
```
UserId = 5
```

**3. Yava≈ü Request'ler (>1000ms):**
```
ElapsedMilliseconds > 1000
```

**4. Belirli Endpoint'e Gelen ƒ∞stekler:**
```
RequestPath like '%/api/post%'
```

**5. Exception ƒ∞√ßeren Loglar:**
```
@Exception is not null
```

**6. Belirli Zaman Aralƒ±ƒüƒ±:**
```
@Timestamp > DateTime('2025-10-25T00:00:00Z')
```

## ÔøΩ PostgreSQL Log Sorgularƒ±

### Structured Logs Tablosu

**Son 24 Saatteki Hatalar:**
```sql
SELECT message, level, raise_date, exception
FROM "Logs"
WHERE level IN ('Error', 'Fatal')
  AND raise_date > NOW() - INTERVAL '24 hours'
ORDER BY raise_date DESC;
```

**En √áok Hata Veren Endpoint'ler:**
```sql
SELECT 
    properties->>'RequestPath' as endpoint,
    COUNT(*) as error_count
FROM "Logs"
WHERE level = 'Error'
  AND properties ? 'RequestPath'
  AND raise_date > NOW() - INTERVAL '7 days'
GROUP BY endpoint
ORDER BY error_count DESC
LIMIT 10;
```

**Ortalama Response Time:**
```sql
SELECT 
    DATE(raise_date) as date,
    AVG((properties->>'ElapsedMilliseconds')::numeric) as avg_response_time
FROM "Logs"
WHERE properties ? 'ElapsedMilliseconds'
  AND raise_date > NOW() - INTERVAL '30 days'
GROUP BY DATE(raise_date)
ORDER BY date;
```

### Activity Logs Tablosu

**Kullanƒ±cƒ±nƒ±n Son Aktiviteleri:**
```sql
SELECT 
    a."ActivityType",
    a."Title",
    a."Timestamp",
    u."UserName"
FROM "ActivityLogs" a
LEFT JOIN "AppUsers" u ON a."UserId" = u."Id"
WHERE a."UserId" = 5
ORDER BY a."Timestamp" DESC
LIMIT 50;
```

**Silinen Post'larƒ±n Audit Trail'i:**
```sql
SELECT 
    a."Title",
    a."Details",
    a."Timestamp",
    u."UserName",
    u."Email"
FROM "ActivityLogs" a
LEFT JOIN "AppUsers" u ON a."UserId" = u."Id"
WHERE a."ActivityType" = 'post_deleted'
  AND a."Timestamp" > NOW() - INTERVAL '30 days'
ORDER BY a."Timestamp" DESC;
```

**G√ºnl√ºk Aktivite ƒ∞statistikleri:**
```sql
SELECT 
    DATE(a."Timestamp") as date,
    a."ActivityType",
    COUNT(*) as activity_count
FROM "ActivityLogs" a
WHERE a."Timestamp" > NOW() - INTERVAL '7 days'
GROUP BY DATE(a."Timestamp"), a."ActivityType"
ORDER BY date DESC, activity_count DESC;
```

## ‚öôÔ∏è Yapƒ±landƒ±rma

### appsettings.json

**Development:**
```json
{
  "Serilog": {
    "SeqUrl": "http://localhost:5341",
    "SeqApiKey": null
  }
}
```

**Production:**
```json
{
  "Serilog": {
    "SeqUrl": "http://seq:80",
    "SeqApiKey": "YOUR_API_KEY_HERE"
  }
}
```

### Retention Policies

| Log Tipi | Saklama S√ºresi | Cleanup Mekanizmasƒ± |
|----------|----------------|---------------------|
| File Logs | 31 g√ºn | Serilog otomatik cleanup |
| Structured Logs | 90 g√ºn | PostgreSQL scheduled job (03:00) |
| Activity Logs | S√ºresiz | Manuel cleanup gerektiƒüinde |

### Production √ñnerileri

1. **Seq API Key Kullanƒ±n:**
   - Seq admin panel'den API key olu≈üturun
   - `appsettings.Production.json` i√ßinde tanƒ±mlayƒ±n

2. **Log Level Ayarlarƒ±:**
   ```json
   {
     "Serilog": {
       "MinimumLevel": {
         "Default": "Information",
         "Override": {
           "Microsoft": "Warning",
           "System": "Warning"
         }
       }
     }
   }
   ```

3. **Sensitive Data Masking:**
   - ≈ûifre, kredi kartƒ±, ki≈üisel bilgileri loglama
   - Connection string'leri mask'le
   - Email adreslerini kƒ±salt (us***@example.com)

4. **Performance Considerations:**
   - Async logging kullan
   - Buffering ile batch write yap
   - Disk space monitoring kur

## üöÄ Kurulum ve Ba≈ülangƒ±√ß

### Docker ile √áalƒ±≈ütƒ±rma

T√ºm servisleri ba≈ülatmak i√ßin:

```bash
# Development
docker compose -f docker-compose.yml -f docker-compose.local.yml up -d

# Production
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### Migration √áalƒ±≈ütƒ±rma

ActivityLogs ve Logs tablolarƒ± migration'lar ile otomatik olu≈üturulur:

```bash
cd src/BlogApp.Persistence
dotnet ef database update --startup-project ../BlogApp.API
```

### Seq Eri≈üimi

- **Development:** http://localhost:5341
- **Production:** Docker network i√ßinden `http://seq:80`

## üìù ƒ∞lgili Dosyalar

### Backend Files
- `src/BlogApp.Domain/Entities/ActivityLog.cs` - Entity tanƒ±mƒ±
- `src/BlogApp.Persistence/Configurations/ActivityLogConfiguration.cs` - EF Core konfig√ºrasyonu
- `src/BlogApp.Persistence/Repositories/ActivityLogRepository.cs` - Repository implementasyonu
- `src/BlogApp.Application/Behaviors/ActivityLoggingBehavior.cs` - MediatR pipeline behavior
- `src/BlogApp.API/Configuration/SerilogConfiguration.cs` - Serilog yapƒ±landƒ±rmasƒ±
- `src/BlogApp.API/Middlewares/ExceptionHandlingMiddleware.cs` - Exception logging
- `src/BlogApp.API/Filters/RequestResponseLoggingFilter.cs` - Request/response logging

### Configuration Files
- `src/BlogApp.API/appsettings.Development.json` - Development ayarlarƒ±
- `src/BlogApp.API/appsettings.Production.json` - Production ayarlarƒ±
- `docker-compose.yml` - Docker servisleri
- `docker-compose.local.yml` - Local geli≈ütirme ayarlarƒ±
- `docker-compose.prod.yml` - Production ayarlarƒ±

## üìö Ek Kaynaklar

- [LOGGING_ARCHITECTURE.md](LOGGING_ARCHITECTURE.md) - Detaylƒ± mimari dok√ºmantasyonu
- [LOGGING_QUICK_REFERENCE.md](LOGGING_QUICK_REFERENCE.md) - Hƒ±zlƒ± ba≈üvuru kƒ±lavuzu
- [LOGGING_COMPARISON.md](LOGGING_COMPARISON.md) - Loglama stratejileri kar≈üƒ±la≈ütƒ±rmasƒ±
- [Serilog Documentation](https://serilog.net/) - Resmi Serilog dok√ºmantasyonu
- [Seq Documentation](https://docs.datalust.co/docs) - Resmi Seq dok√ºmantasyonu
